"use strict";(()=>{var e={};e.id=425,e.ids=[425],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3745:e=>{e.exports=import("firebase/app")},1492:e=>{e.exports=import("firebase/firestore")},6714:(e,t,a)=>{a.a(e,async(e,s)=>{try{a.r(t),a.d(t,{config:()=>l,default:()=>d,routeModule:()=>p});var r=a(1802),n=a(7153),o=a(6249),i=a(9960),c=e([i]);i=(c.then?(await c)():c)[0];let d=(0,o.l)(i,"default"),l=(0,o.l)(i,"config"),p=new r.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/scanBottle",pathname:"/api/scanBottle",bundlePath:"",filename:""},userland:i});s()}catch(e){s(e)}})},6633:(e,t,a)=>{a.a(e,async(e,s)=>{try{a.d(t,{db:()=>d});var r=a(3745),n=a(1492),o=e([r,n]);[r,n]=o.then?(await o)():o;let i={apiKey:process.env.NEXT_PUBLIC_FIREBASE_API_KEY,authDomain:process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,projectId:process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,storageBucket:process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,messagingSenderId:process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,appId:process.env.NEXT_PUBLIC_FIREBASE_APP_ID},c=(0,r.getApps)().length?(0,r.getApps)()[0]:(0,r.initializeApp)(i),d=(0,n.getFirestore)(c);s()}catch(e){s(e)}})},9960:(e,t,a)=>{a.a(e,async(e,s)=>{try{a.r(t),a.d(t,{default:()=>handler});var r=a(6633),n=a(1492);!function(){var e=Error("Cannot find module 'uuid'");throw e.code="MODULE_NOT_FOUND",e}();var o=e([r,n]);async function handler(e,t){try{let{bottleId:a}=e.query;if(!a)return t.status(400).json({error:"Missing bottle ID"});let s=e.cookies.ls_user;s||(s=Object(function(){var e=Error("Cannot find module 'uuid'");throw e.code="MODULE_NOT_FOUND",e}())(),t.setHeader("Set-Cookie",`ls_user=${s}; Path=/; HttpOnly; Max-Age=31536000`));let o=(0,n.doc)(r.db,"bottles",a),i=await (0,n.getDoc)(o);if(!i.exists())return t.status(404).json({error:"Bottle not found"});let c=i.data(),d=(0,n.doc)(r.db,"users",s),l=await (0,n.getDoc)(d);l.exists()||(await (0,n.setDoc)(d,{createdAt:new Date,displayName:"Saint",level:"Saint Initiation",points:0,scans:[]}),l=await (0,n.getDoc)(d));let p=l.data(),u=p.scans.includes(a),_=0;return u||(_=1),u||await (0,n.updateDoc)(d,{points:(0,n.increment)(_),scans:(0,n.arrayUnion)(a)}),u||await (0,n.updateDoc)(o,{totalScans:(0,n.increment)(1)}),await (0,n.addDoc)((0,n.collection)(r.db,"scans"),{bottleId:a,userId:s,timestamp:new Date,pointsAwarded:_}),t.status(200).json({bottle:{songURL:c.songURL,isPrizeBottle:c.isPrizeBottle,totalScans:(c.totalScans||0)+(u?0:1)},user:{points:p.points+_,displayName:p.displayName,level:p.level},awarded:_,alreadyScanned:u})}catch(e){return console.error("Scan API error:",e),t.status(500).json({error:e.message})}}[r,n]=o.then?(await o)():o,s()}catch(e){s(e)}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[222],()=>__webpack_exec__(6714));module.exports=a})();